drop extension if exists url cascade;
DROP EXTENSION
create extension url;
CREATE EXTENSION
--
-- Test url_test
--
drop table if exists test_url;
DROP TABLE
create table test_url (id int, u pg_url);
CREATE TABLE
insert into test_url values (1, 'http://www.test.com:80/file');
INSERT 0 1
insert into test_url values (2, 'test.es');
INSERT 0 1
insert into test_url values (3, 'http://www.test.com');
INSERT 0 1
insert into test_url values (4, pg_url('ftp://www.test.com/file?param1=1&param2=2'));
INSERT 0 1
insert into test_url values (5, pg_url('http','example.com',80,'file'));
INSERT 0 1
insert into test_url values (6, pg_url('ftp','example.com','file'));
INSERT 0 1
insert into test_url values (7, pg_url('http://ulb.be', '/file'));
INSERT 0 1
insert into test_url values (7, pg_url('http://ulb.be', 'www.file.com/file2'));
INSERT 0 1
-- --> Functions testing
select * from test_url;
 id |                       u                       
----+-----------------------------------------------
  1 | http://@www.test.com:80/file
  2 | http://@test.es:80/
  3 | http://@www.test.com:80/
  4 | ftp://@www.test.com:21/file?param1=1&param2=2
  5 | http://@example.com:80/file
  6 | ftp://@example.com:21/file
  7 | http://@ulb.be:80//file
  7 | http://@ulb.be:80/www.file.com/file2
(8 rows)

select id, get_host(u) from test_url;
 id |   get_host   
----+--------------
  1 | www.test.com
  2 | test.es
  3 | www.test.com
  4 | www.test.com
  5 | example.com
  6 | example.com
  7 | ulb.be
  7 | ulb.be
(8 rows)

select id, get_port(u) from test_url;
 id | get_port 
----+----------
  1 |       80
  2 |       80
  3 |       80
  4 |       21
  5 |       80
  6 |       21
  7 |       80
  7 |       80
(8 rows)

select id, get_protocol(u) from test_url;
 id | get_protocol 
----+--------------
  1 | http
  2 | http
  3 | http
  4 | ftp
  5 | http
  6 | ftp
  7 | http
  7 | http
(8 rows)

select id, get_file(u) from test_url;
 id |        get_file        
----+------------------------
  1 | file
  2 | 
  3 | 
  4 | file?param1=1&param2=2
  5 | file
  6 | file
  7 | /file
  7 | www.file.com/file2
(8 rows)

select id, get_userinfo(u) from test_url;
 id | get_userinfo 
----+--------------
  1 | 
  2 | 
  3 | 
  4 | 
  5 | 
  6 | 
  7 | 
  7 | 
(8 rows)

select id, get_default_port(u) from test_url;
 id | get_default_port 
----+------------------
  1 |               80
  2 |               80
  3 |               80
  4 |               21
  5 |               80
  6 |               21
  7 |               80
  7 |               80
(8 rows)

select id, getAuthority(u) from test_url;
select id, getPath(u) from test_url;
select id, getQuery(u) from test_url;
select id, getRef(u) from test_url;
drop table if exists test_equals;
DROP TABLE
create table test_equals (id int, u1 pg_url, u2 pg_url);
CREATE TABLE
insert into test_equals values (1, 'http://www.test.com:80/file', 'http://www.test.com:80/file');
INSERT 0 1
insert into test_equals values (2, 'http://www.test.com:80/file', 'https://www.test2.es:95/file');
INSERT 0 1
insert into test_equals values (3, 'http://www.test.com:80/file2', 'http://www.test.com:80/file');
INSERT 0 1
select * from test_equals;
 id |              u1               |              u2               
----+-------------------------------+-------------------------------
  1 | http://@www.test.com:80/file  | http://@www.test.com:80/file
  2 | http://@www.test.com:80/file  | https://@www.test2.es:95/file
  3 | http://@www.test.com:80/file2 | http://@www.test.com:80/file
(3 rows)

select * from test_equals where pg_url_equals(u1, u2);
 id |              u1              |              u2              
----+------------------------------+------------------------------
  1 | http://@www.test.com:80/file | http://@www.test.com:80/file
(1 row)

select * from test_equals where not pg_url_equals(u1, u2);
 id |              u1               |              u2               
----+-------------------------------+-------------------------------
  2 | http://@www.test.com:80/file  | https://@www.test2.es:95/file
  3 | http://@www.test.com:80/file2 | http://@www.test.com:80/file
(2 rows)

select * from test_equals where u1 = u2;
 id |              u1               |              u2              
----+-------------------------------+------------------------------
  1 | http://@www.test.com:80/file  | http://@www.test.com:80/file
  3 | http://@www.test.com:80/file2 | http://@www.test.com:80/file
(2 rows)

select * from test_equals where same_host(u1,u2);
 id |              u1               |              u2              
----+-------------------------------+------------------------------
  1 | http://@www.test.com:80/file  | http://@www.test.com:80/file
  3 | http://@www.test.com:80/file2 | http://@www.test.com:80/file
(2 rows)

select * from test_equals where same_file(u1,u2);
 id |              u1              |              u2              
----+------------------------------+------------------------------
  1 | http://@www.test.com:80/file | http://@www.test.com:80/file
(1 row)

select * from test_equals where u1 <> u2;
 id |              u1              |              u2               
----+------------------------------+-------------------------------
  2 | http://@www.test.com:80/file | https://@www.test2.es:95/file
(1 row)

select * from test_equals where u1 < u2;
 id |              u1              |              u2               
----+------------------------------+-------------------------------
  2 | http://@www.test.com:80/file | https://@www.test2.es:95/file
(1 row)

select * from test_equals where u1 <= u2;
 id |              u1               |              u2               
----+-------------------------------+-------------------------------
  1 | http://@www.test.com:80/file  | http://@www.test.com:80/file
  2 | http://@www.test.com:80/file  | https://@www.test2.es:95/file
  3 | http://@www.test.com:80/file2 | http://@www.test.com:80/file
(3 rows)

select * from test_equals where u1 > u2;
 id | u1 | u2 
----+----+----
(0 rows)

select * from test_equals where u1 >= u2;
 id |              u1               |              u2              
----+-------------------------------+------------------------------
  1 | http://@www.test.com:80/file  | http://@www.test.com:80/file
  3 | http://@www.test.com:80/file2 | http://@www.test.com:80/file
(2 rows)

create index test_url_u on test_url using btree (u);
CREATE INDEX
set enable_seqscan = off;
SET
explain select * from test_url where u = 'test.es';
                                 QUERY PLAN                                 
----------------------------------------------------------------------------
 Index Scan using test_url_u on test_url  (cost=0.13..8.15 rows=1 width=36)
   Index Cond: (u = 'http://@test.es:80/'::pg_url)
(2 rows)

explain select * from test_url where same_host(u,'test.es');
                                 QUERY PLAN                                 
----------------------------------------------------------------------------
 Index Scan using test_url_u on test_url  (cost=0.13..8.15 rows=1 width=36)
   Index Cond: (u = 'http://@test.es:80/'::pg_url)
(2 rows)

explain select same_host(u,'test.es') from test_url;
                                   QUERY PLAN                                    
---------------------------------------------------------------------------------
 Index Only Scan using test_url_u on test_url  (cost=0.13..12.27 rows=8 width=1)
(1 row)

explain select same_file(u,'test.es') from test_url;
                                   QUERY PLAN                                    
---------------------------------------------------------------------------------
 Index Only Scan using test_url_u on test_url  (cost=0.13..14.25 rows=8 width=1)
(1 row)

explain select pg_url_equals(u,'test.es') from test_url;
                                   QUERY PLAN                                    
---------------------------------------------------------------------------------
 Index Only Scan using test_url_u on test_url  (cost=0.13..14.25 rows=8 width=1)
(1 row)

